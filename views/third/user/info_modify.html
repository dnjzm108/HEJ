<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/css/third/info_modify.css">
</head>

<body>

    <div id="wrap">
        <div class="box">

            <form id="info_modify" method="post" action="/user/info_after_modify" enctype="multipart/form-data">
                <div class="info_image">
                    <a href="/"><img src="/uploads/logo_new_2018.png"></a>
                </div>
                <h4>내 정보 수정</h4>
                <table>

                    <p style="display: none">번호</p>
                    <input type="text" name="id" class="" style="display:none">

                    <tr class="">
                        <td class="info_title">아이디</td>
                        <td>{{userid}}</td>
                        <input type="hidden" name="userid" value="{{userid}}">
                    </tr>
                    <tr class="">
                        <td class="info_title">비밀번호</td>
                        <td>
                            <span class="ps_box">
                                <input type="password" id="pwd1" class="int" name="userpw" value="{{userpw}}"
                                    minlength="6">
                                <span id="pwd1_msg"> </span>
                            </span>
                        </td>

                    </tr>

                    <tr class="">
                        <td class="info_title">비밀번호 확인</td>
                        <td>
                            <span class="ps_box">
                                <input type="password" id="pwd2" class="int" name="userpw_check" value="{{userpw}}"
                                    minlength="6">
                                <span id="pwd2_msg"></span>
                            </span>
                        </td>
                    </tr>
                    <tr class="">
                        <td class="info_title">성별</td>
                        <td>{{gender}}</td>
                    </tr>
                    <tr class="">
                        <td class="info_title">생년월일</td>
                        <td>{{user_birth}}</td>
                    <tr class="">
                        <td class="info_title">프로필 이미지 </td>
                        <input type="hidden" name="userimage1" value="{{userimage}}">
                        <td><img id="userimage" src="{{userimage}}">
                            <input type="file" name="userimage">
                        </td>
                    </tr>
                    </tr>
                    <tr class="">
                        <td class="info_title">이름</td>
                        <td>{{user_name}}</td>
                    </tr>

                    <tr class="">
                        <td class="info_title">전화번호</td>
                        <td>
                            <span class="ps_box">
                                <input type="text" id="user_number" class="int" name="user_number"
                                    value="{{user_number}}" minlength="11" maxlength="11">
                                <span id="user_number_msg"></span>
                            </span>
                        </td>
                    </tr>
                    <tr class="">
                        <td class="info_title">이메일</td>
                        <td>
                            <span class="ps_box">
                                <input type="text" name="user_email" class="int" value="{{user_email}}" minlength="6">
                            </span>
                        </td>
                    </tr>
                    <tr class="">
                        <td class="info_title">주소</td>
                        <td>{{user_address}}</td>
                    </tr>
                    <tr>
                        <td class="info_title">주소변경</td>
                        <td class="change_address">
                            <span class="ps2_box">
                                <input type="text" id="addressInput" class="int" name="addressInput"
                                    placeholder="주소를 입력해주세요.">
                            </span>
                            <!-- <button id="addressSearch">주소검색하기</button> -->
                            <p class="btn" id="addressSearch">주소검색하기</p>
                            <ul id="addressList"></ul>
                            <div>
                                <span class="ps_box">

                                    <input type="text" name="user_address1" class="int" id="addressNumber" size="10"
                                        placeholder="우편번호">
                                </span>
                                <span class="ps_box">
                                    <input type="text" name="user_address2" class="int" id="address1" size="40"
                                        placeholder="주소">
                                </span>
                                <span class="ps_box address2">
                                    <input type="text" name="user_address3" class="int" id="address2"
                                        placeholder="상세주소">
                                </span>
                            </div>
                        </td>
                    </tr>
                    <tr class="">
                        <td class="info_title">가입한 날짜</td>
                        <td>{{userdt}}</td>
                    </tr>
                </table>

                <div class="">
                    <a class="btn2" href="/user/info?checked=1">취소</a>
                    <input type="submit" class="btn2" value="수정완료">
                </div>
            </form>
        </div>

    </div>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', init);
        function init() {
            const searchBtn = document.querySelector('#addressSearch');
            searchBtn.addEventListener('click', getAddress);
        }

        async function getAddress() {
            const addressInput = document.querySelector('#addressInput');
            const addressList = document.querySelector('#addressList');
            if (addressInput.value.length == 0) {
                alert('주소를 입력해주세요.');
                addressInput.focus();
                return false;
            } //주소창 결과값이 아무것도 입력되지 않았을때 얼럴트창이뜨고 커서가 주소창으로 옴겨짐.

            let options = {
                method: 'GET',
                headers: {
                    "Authorization": "KakaoAK 82ff941469e77067f4ed407f2d33553d"
                }
            }
            let result = await fetch('https://dapi.kakao.com/v2/local/search/address.json?analyze_type=similar&page=1&size=10&query=' + addressInput.value, options)
            let json = await result.json();
            console.log(json)

            addressList.innerHTML = '';
            if (json.documents.length == 0) {
                addressList.innerHTML = '<li>결과값이 존재하지 않습니다.</li>';
                return false;
            }

            json.documents.forEach(v => {
                console.log(v.address_name);
                const li = document.createElement('li')
                li.innerHTML = v.address_name;
                li.dataset.x = v.x;
                li.dataset.y = v.y; //첫번째 인자값의 요소에 있는 y를 dataset y 값에 넣겟다.
                li.addEventListener('click', getAddressDetail);
                addressList.appendChild(li);
            })
        }

        async function getAddressDetail() {
            let x = this.dataset.x;
            let y = this.dataset.y;

            let options = {
                method: 'GET',
                headers: {
                    "Authorization": "KakaoAK 82ff941469e77067f4ed407f2d33553d"
                }
            }

            //https://dapi.kakao.com/v2/local/geo/coord2address.json?input_coord=WGS84&y=37.5397559555383&x=127.123313958545
            let url = `https://dapi.kakao.com/v2/local/geo/coord2address.json?input_coord=WGS84&x=${x}&y=${y}`
            let result = await fetch(url, options) // 요청의 결과값만 반환해줌
            let json = await result.json();     // 응답의 body영역을 읽기위해 body영역의 타입이 application/json 타입으로 오기떄문

            console.log(json);

            if (json.documents[0].road_address == null) {
                let address_name = json.documents[0].address.address_name;
                document.querySelector('#address1').value = `${address_name} `;


            } else {
                let address_name = json.documents[0].road_address.address_name;
                let buliding_name = json.documents[0].road_address.building_name;
                let zone_no = json.documents[0].road_address.zone_no;

                document.querySelector('#addressNumber').value = zone_no;
                document.querySelector('#address1').value = `${address_name} ${buliding_name}`;
            }
        }
    </script>
    {% include "../layout/bottom.html" %}